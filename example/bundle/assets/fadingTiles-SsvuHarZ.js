import{i as N,j as w,G as U,k as G,Q as k,W as V,S as H,a as Q,O as $}from"./three.module-llkpyLgW.js";import{g as q}from"./lil-gui.module.min-DGepGIYL.js";import{C as Z}from"./CameraTransitionManager-B_WAu1BC.js";import{E as J}from"./EnvironmentControls-lFV-KO1M.js";import{T as y}from"./TilesRenderer-COIzxhkT.js";import"./B3DMLoader-BbySC5wb.js";import"./readMagicBytes-C5ZyfJzm.js";import"./LoaderBase-QLlipkOW.js";import"./GLTFLoader-KDqsLDsn.js";import"./PNTSLoader-e5Dx7bf2.js";import"./I3DMLoader-DX535fGk.js";import"./CMPTLoader-BdZwSK3N.js";import"./GLTFExtensionLoader-bnHC9qPo.js";const{clamp:S}=N;class K{constructor(){this.duration=250,this.fadeCount=0,this._lastTick=-1,this._fadeState=new Map,this._fadeParams=new WeakMap,this.onFadeComplete=null,this.onFadeStart=null,this.onFadeSetComplete=null,this.onFadeSetStart=null}prepareObject(e){e.traverse(a=>{a.material&&this.prepareMaterial(a.material)})}deleteObject(e){if(!e)return;this.completeFade(e);const a=this._fadeParams;e.traverse(n=>{const t=n.material;t&&(a.delete(t),t.onBeforeCompile=null,t.needsUpdate=!0)})}prepareMaterial(e){const a=this._fadeParams;if(a.has(e))return;const n={fadeIn:{value:0},fadeOut:{value:0}};e.defines={FEATURE_FADE:0},e.onBeforeCompile=t=>{t.uniforms={...t.uniforms,...n},t.fragmentShader=t.fragmentShader.replace(/void main\(/,d=>`
					#if FEATURE_FADE

					// adapted from https://www.shadertoy.com/view/Mlt3z8
					float bayerDither2x2( vec2 v ) {

						return mod( 3.0 * v.y + 2.0 * v.x, 4.0 );

					}

					float bayerDither4x4( vec2 v ) {

						vec2 P1 = mod( v, 2.0 );
						vec2 P2 = floor( 0.5 * mod( v, 4.0 ) );
						return 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );

					}

					uniform float fadeIn;
					uniform float fadeOut;
					#endif

					${d}
				`).replace(/#include <dithering_fragment>/,d=>`

					${d}

					#if FEATURE_FADE

					float bayerValue = bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) );
					float bayerBins = 16.0;
					float dither = ( 0.5 + bayerValue ) / bayerBins;
					if ( dither >= fadeIn ) {

						discard;

					}

					if ( dither < fadeOut ) {

						discard;

					}

					#endif

				`)},a.set(e,n)}guaranteeState(e){const a=this._fadeState;if(a.has(e))return!1;const n={fadeInTarget:0,fadeOutTarget:0,fadeIn:0,fadeOut:0};a.set(e,n);const t=this._fadeParams;return e.traverse(d=>{const c=d.material;if(c&&t.has(c)){const u=t.get(c);u.fadeIn.value=0,u.fadeOut.value=0}}),!0}completeFade(e){const a=this._fadeState;a.has(e)&&(a.delete(e),e.traverse(n=>{const t=n.material;t&&t.defines.FEATURE_FADE!==0&&(t.defines.FEATURE_FADE=0,t.needsUpdate=!0)}),this.fadeCount--,this.onFadeComplete&&this.onFadeComplete(e),this.fadeCount===0&&this.onFadeSetComplete&&this.onFadeSetComplete())}completeAllFades(){this._fadeState.forEach((e,a)=>{this.completeFade(a)})}forEachObject(e){this._fadeState.forEach((a,n)=>e(n))}fadeIn(e){const a=this.guaranteeState(e),n=this._fadeState.get(e);n.fadeInTarget=1,n.fadeOutTarget=0,n.fadeOut=0,a&&(this.fadeCount++,this.fadeCount===1&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(e))}fadeOut(e){const a=this.guaranteeState(e),n=this._fadeState.get(e);n.fadeOutTarget=1,a&&(n.fadeInTarget=1,n.fadeIn=1,this.fadeCount++,this.fadeCount===1&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(e))}update(){const e=window.performance.now();this._lastTick===-1&&(this._lastTick=e);const a=S((e-this._lastTick)/this.duration,0,1);this._lastTick=e;const n=this._fadeState,t=this._fadeParams;n.forEach((d,c)=>{const{fadeOutTarget:u,fadeInTarget:g}=d;let{fadeOut:h,fadeIn:r}=d;const T=Math.sign(g-r);r=S(r+T*a,0,1);const E=Math.sign(u-h);h=S(h+E*a,0,1),d.fadeIn=r,d.fadeOut=h;const v=+(h!==u||r!==g);c.traverse(W=>{const _=W.material;if(_&&t.has(_)){const D=t.get(_);D.fadeIn.value=r,D.fadeOut.value=h,v!==_.defines.FEATURE_FADE&&(_.defines.FEATURE_FADE=v,_.needsUpdate=!0)}}),((h===1||h===0)&&(r===1||r===0)||h>=r)&&this.completeFade(c)})}}const P=new w,O=new w,R=new k,L=new k,x=new w;function X(i,e,a){if(i.visible=!0,!a)this._fadeGroup.add(i),this._fadeManager.fadeOut(i);else{const n=e.__depthFromRenderedParent===0;n||(this._initialLayerRendered=!0),(!n||this.fadeRootTiles||this._initialLayerRendered)&&this._fadeManager.fadeIn(i)}}function Y(i,e){this._fadeManager.prepareObject(i),this._tileMap.set(i,e)}function j(i){this._fadeManager.deleteObject(i)}function ee(i){i.parent===this._fadeGroup&&this._fadeGroup.remove(i)}function te(i){this._prevCameraTransforms.set(i,new G)}function ae(i){this._prevCameraTransforms.delete(i)}function ie(){const i=this._fadeManager,e=this.tiles;this._fadingBefore=i.fadeCount,this._displayActiveTiles=this.displayActiveTiles,e.displayActiveTiles=!0}function ne(){const i=this._fadeManager,e=this._fadeGroup,a=this._displayActiveTiles,n=this._fadingBefore,t=this.tiles,d=this._prevCameraTransforms,c=this._tileMap,u=t.lruCache,g=t.cameras;t.displayActiveTiles=a,i.update();const h=i.fadeCount;if(n!==0&&h!==0&&t.dispatchEvent({type:"fade-change"}),a||t.visibleTiles.forEach(r=>{r.cached.scene.visible=r.__inFrustum}),this.maximumFadeOutTiles<e.children.length){let r=!0;g.forEach(T=>{if(!d.has(T))return;const E=T.matrixWorld,v=d.get(T);E.decompose(O,L,x),v.decompose(P,R,x);const M=L.angleTo(R),A=O.distanceTo(P);r=r&&(M>.25||A>.1)}),r&&i.completeAllFades()}g.forEach(r=>{d.get(r).copy(r.matrixWorld)}),i.forEachObject(r=>{u.markUsed(c.get(r))})}class I{get fadeDuration(){return this._fadeManager.duration}set fadeDuration(e){this._fadeManager.duration=Number(e)}get fadingTiles(){return this._fadeManager.fadeCount}constructor(e){e={maximumFadeOutTiles:50,fadeRootTiles:!1,fadeDuration:250,...e},this.name="FADE_TILES_PLUGIN",this.tiles=null,this._fadeManager=new K,this._initialLayerRendered=!1,this._prevCameraTransforms=null,this._fadeGroup=null,this._tileMap=null,this.maximumFadeOutTiles=e.maximumFadeOutTiles,this.fadeRootTiles=e.fadeRootTiles,this.fadeDuration=e.fadeDuration}init(e){const a=new U;a.name="TilesFadeGroup",e.group.add(a);const n=this._fadeManager;n.onFadeSetStart=()=>e.dispatchEvent({type:"fade-start"}),n.onFadeSetComplete=()=>e.dispatchEvent({type:"fade-end"}),n.onFadeComplete=ee.bind(this),this.tiles=e,this._fadeManager=n,this._fadeGroup=a,this._tileMap=new Map,this._prevCameraTransforms=new Map,e.cameras.forEach(t=>{this._prevCameraTransforms.set(t,new G)}),this._onLoadModel=t=>Y.call(this,t.scene,t.tile),this._onDisposeModel=t=>j.call(this,t.scene),this._onTileVisibilityChange=t=>X.call(this,t.scene,t.tile,t.visible),this._onAddCamera=t=>te.call(this,t.camera),this._onDeleteCamera=t=>ae.call(this,t.camera),this._onUpdateBefore=()=>ie.call(this),this._onUpdateAfter=()=>ne.call(this),e.addEventListener("load-model",this._onLoadModel),e.addEventListener("dispose-model",this._onDisposeModel),e.addEventListener("tile-visibility-change",this._onTileVisibilityChange),e.addEventListener("add-camera",this._onAddCamera),e.addEventListener("delete-camera",this._onDeleteCamera),e.addEventListener("update-before",this._onUpdateBefore),e.addEventListener("update-after",this._onUpdateAfter)}dispose(){const e=this.tiles;e.removeEventListener("load-model",this._onLoadModel),e.removeEventListener("dispose-model",this._onDisposeModel),e.removeEventListener("tile-visibility-change",this._onTileVisibilityChange),e.removeEventListener("add-camera",this._onAddCamera),e.removeEventListener("delete-camera",this._onDeleteCamera),e.removeEventListener("update-before",this._onUpdateBefore),e.removeEventListener("update-after",this._onUpdateAfter)}}let p,C,m,s,f,F,l;const o={reinstantiateTiles:B,fadeRootTiles:!0,useFade:!0,errorTarget:12,fadeDuration:.5,renderScale:1,fadingGroundTiles:"0 tiles",orthographic:!1,transitionDuration:.25};re();z();function re(){m=new V({antialias:!0}),m.setPixelRatio(window.devicePixelRatio),m.setSize(window.innerWidth,window.innerHeight),m.setClearColor(14208704),document.body.appendChild(m.domElement),C=new H,l=new Z(new Q(60,window.innerWidth/window.innerHeight,.25,4e3),new $(-1,1,1,-1,0,4e3)),l.camera.position.set(20,10,20),l.camera.lookAt(0,0,0),l.addEventListener("camera-changed",({camera:t,prevCamera:d})=>{f.deleteCamera(d),s.deleteCamera(d),f.setCamera(t),s.setCamera(t),p.setCamera(t)}),p=new J(C,l.camera,m.domElement),p.minZoomDistance=2,p.cameraRadius=1,F=new U,F.rotation.set(Math.PI/2,0,0),C.add(F),B(),b(),window.addEventListener("resize",b,!1);const i=new q,e=i.addFolder("camera");e.add(o,"orthographic").onChange(t=>{l.fixedPoint.copy(p.pivotPoint),l.toggle()}),e.add(o,"transitionDuration",0,1.5);const a=i.addFolder("fade");a.add(o,"useFade"),a.add(o,"fadeRootTiles"),a.add(o,"errorTarget",0,1e3),a.add(o,"fadeDuration",0,5),a.add(o,"renderScale",.1,1,.05).onChange(t=>m.setPixelRatio(t*window.devicePixelRatio));const n=a.add(o,"fadingGroundTiles").listen().disable();n.domElement.style.opacity=1,i.add(o,"reinstantiateTiles"),i.open()}function B(){s&&(s.dispose(),f.dispose()),s=new y("https://raw.githubusercontent.com/NASA-AMMOS/3DTilesSampleData/master/msl-dingo-gap/0528_0260184_to_s64o256_colorize/0528_0260184_to_s64o256_colorize/0528_0260184_to_s64o256_colorize_tileset.json"),s.fetchOptions.mode="cors",s.lruCache.minSize=900,s.lruCache.maxSize=1300,s.errorTarget=12,s.registerPlugin(new I),s.setCamera(l.camera),f=new y("https://raw.githubusercontent.com/NASA-AMMOS/3DTilesSampleData/master/msl-dingo-gap/0528_0260184_to_s64o256_colorize/0528_0260184_to_s64o256_sky/0528_0260184_to_s64o256_sky_tileset.json"),f.fetchOptions.mode="cors",f.lruCache=s.lruCache,f.registerPlugin(new I),f.setCamera(l.camera),F.add(s.group,f.group)}function b(){const{perspectiveCamera:i,orthographicCamera:e}=l,a=window.innerWidth/window.innerHeight;e.bottom=-40,e.top=40,e.left=-40*a,e.right=40*a,e.updateProjectionMatrix(),i.aspect=a,i.updateProjectionMatrix(),m.setSize(window.innerWidth,window.innerHeight)}function z(){requestAnimationFrame(z),p.enabled=!l.animating,p.update(),l.duration=1e3*o.transitionDuration,l.update();const i=l.camera;i.updateMatrixWorld();const e=s.getPluginByName("FADE_TILES_PLUGIN");e.fadeRootTiles=o.fadeRootTiles,e.fadeDuration=o.useFade?o.fadeDuration*1e3:0,s.errorTarget=o.errorTarget,s.setCamera(i),s.setResolutionFromRenderer(i,m),s.update();const a=f.getPluginByName("FADE_TILES_PLUGIN");a.fadeRootTiles=o.fadeRootTiles,a.fadeDuration=o.useFade?o.fadeDuration*1e3:0,f.setCamera(i),f.setResolutionFromRenderer(i,m),f.update(),m.render(C,i),o.fadingGroundTiles=e.fadingTiles+" tiles"}
