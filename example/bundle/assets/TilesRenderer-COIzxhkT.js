import{B as ve}from"./B3DMLoader-BbySC5wb.js";import{P as Te}from"./PNTSLoader-e5Dx7bf2.js";import{I as we}from"./I3DMLoader-DX535fGk.js";import{C as Pe}from"./CMPTLoader-BdZwSK3N.js";import{G as Re}from"./GLTFExtensionLoader-bnHC9qPo.js";import{k as w,G as Ce,l as oe,j as x,aw as re,m as Me,B as Fe,d as Ie,aq as ke,aF as Ae,E as Le,V as H,L as Ee}from"./three.module-llkpyLgW.js";import{r as De}from"./readMagicBytes-C5ZyfJzm.js";import{a as Ve}from"./lil-gui.module.min-DGepGIYL.js";function X(i){let e;try{e=new URL(i,"http://fakehost.com/")}catch{return null}const t=e.pathname.split("/").pop(),s=t.lastIndexOf(".");return s===-1||s===t.length-1?null:t.substring(s+1)}class Ue{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){e.length===1?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),o=e(s);return n<o?-1:n>o?1:0}):this._unloadPriorityCallback=e}constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this._unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,o=this.itemList,r=this.callbacks;return o.push(e),n.add(e),s.set(e,Date.now()),r.set(e,t),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,o=this.callbacks;if(s.has(e)){o.get(e)(e);const r=n.indexOf(e);return n.splice(r,1),t.delete(e),s.delete(e),o.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,s=this.itemList,n=this.itemSet,o=this.usedSet,r=this.callbacks,a=s.length-o.size,l=s.length-t,u=this.unloadPriorityCallback||this.defaultPriorityCallback;if(l>0&&a>0){s.sort((f,_)=>{const g=o.has(f),b=o.has(_);return g&&b?0:!g&&!b?-u(f,_):g?1:-1});const h=Math.min(l,a),m=Math.max(t*e,h*e);let c=Math.min(m,a);c=Math.ceil(c);const d=s.splice(0,c);for(let f=0,_=d.length;f<_;f++){const g=d[f];r.get(g)(g),n.delete(g),r.delete(g)}}}scheduleUnload(e=!0){this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()}))}}class Y{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise((s,n)=>{const o=(...l)=>t(...l).then(s).catch(n),r=this.items,a=this.callbacks;r.push(e),a.set(e,o),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const o=e.pop(),r=t.get(o);t.delete(o),r(o).then(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}).catch(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const F=0,I=1,W=2,C=3,U=4,O=6378137,Oe=1/298.257223563,Be=-(Oe*O-O);function G(i){return i===C||i===U}function P(i,e){return i.__lastFrameVisited===e&&i.__used}function ae(i,e){i.__lastFrameVisited!==e&&(i.__lastFrameVisited=e,i.__used=!1,i.__inFrustum=!1,i.__isLeaf=!1,i.__visible=!1,i.__active=!1,i.__error=1/0,i.__distanceFromCamera=1/0,i.__childrenWereVisible=!1,i.__allChildrenLoaded=!1)}function le(i,e,t,s){if(s.ensureChildrenArePreprocessed(i),ae(i,e),i.__used=!0,t.markUsed(i),i.__contentEmpty){const n=i.children;for(let o=0,r=n.length;o<r;o++)le(n[o],e,t,s)}}function ce(i,e){if(e.ensureChildrenArePreprocessed(i),i.__contentEmpty&&(!i.__externalTileSet||G(i.__loadingState))){const s=i.children;for(let n=0,o=s.length;n<o;n++){const r=s[n];ce(r,e)}}else e.requestTileContents(i)}function ue(i,e=null,t=null,s=null,n=0){if(e&&e(i,s,n)){t&&t(i,s,n);return}const o=i.children;for(let r=0,a=o.length;r<a;r++)ue(o[r],e,t,i,n+1);t&&t(i,s,n)}function he(i,e){e.ensureChildrenArePreprocessed(i);const t=e.stats,s=e.frameCount,n=e.errorTarget,o=e.maxDepth,r=e.loadSiblings,a=e.lruCache,l=e.stopAtEmptyTiles;if(ae(i,s),e.tileInView(i)===!1)return!1;if(i.__used=!0,a.markUsed(i),i.__inFrustum=!0,t.inFrustum++,(l||!i.__contentEmpty)&&!i.__externalTileSet&&(e.calculateError(i),i.__error<=n||e.maxDepth>0&&i.__depth+1>=o))return!0;let h=!1;const m=i.children;for(let c=0,d=m.length;c<d;c++){const f=m[c],_=he(f,e);h=h||_}if(h&&r)for(let c=0,d=m.length;c<d;c++){const f=m[c];le(f,s,a,e)}return!0}function de(i,e){const t=e.stats,s=e.frameCount;if(!P(i,s))return;t.used++;const n=i.children;let o=!1;for(let r=0,a=n.length;r<a;r++){const l=n[r];o=o||P(l,s)}if(!o)i.__isLeaf=!0;else{let r=!1,a=!0;for(let l=0,u=n.length;l<u;l++){const h=n[l];if(de(h,e),r=r||h.__wasSetVisible||h.__childrenWereVisible,P(h,s)){const m=h.__allChildrenLoaded||!h.__contentEmpty&&G(h.__loadingState)||!h.__externalTileSet&&h.__contentEmpty&&h.children.length===0||h.__externalTileSet&&h.__loadingState===U;a=a&&m}}i.__childrenWereVisible=r,i.__allChildrenLoaded=a}}function fe(i,e){const t=e.stats,s=e.frameCount;if(!P(i,s))return;const n=e.lruCache;if(i.__isLeaf){i.__loadingState===C?(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++):!n.isFull()&&(!i.__contentEmpty||i.__externalTileSet)&&e.requestTileContents(i);return}const o=(e.errorTarget+1)*e.errorThreshold,r=i.__error<=o,a=r||i.refine==="ADD",u=!i.__contentEmpty||i.__externalTileSet,h=G(i.__loadingState)&&u,m=i.__childrenWereVisible,c=i.children,d=i.__allChildrenLoaded;if(a&&!h&&!n.isFull()&&u&&e.requestTileContents(i),(r&&!d&&!m&&h||i.refine==="ADD"&&h)&&(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++),i.refine!=="ADD"&&r&&!d&&h)for(let f=0,_=c.length;f<_;f++){const g=c[f];P(g,s)&&!n.isFull()&&ce(g,e)}else for(let f=0,_=c.length;f<_;f++){const g=c[f];P(g,s)&&fe(g,e)}}function me(i,e){const t=e.frameCount,s=P(i,t);if(s||i.__usedLastFrame){let n=!1,o=!1;s&&(n=i.__active,e.displayActiveTiles?o=i.__active||i.__visible:o=i.__visible),!i.__contentEmpty&&i.__loadingState===C&&(i.__wasSetActive!==n&&e.setTileActive(i,n),i.__wasSetVisible!==o&&e.setTileVisible(i,o)),i.__wasSetActive=n,i.__wasSetVisible=o,i.__usedLastFrame=s;const r=i.children;for(let a=0,l=r.length;a<l;a++){const u=r[a];me(u,e)}}}const Z=Symbol("PLUGIN_REGISTERED"),K=(i,e)=>i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?-1:1:i.__inFrustum!==e.__inFrustum?i.__inFrustum?1:-1:i.__used!==e.__used?i.__used?1:-1:i.__error!==e.__error?i.__error>e.__error?1:-1:i.__distanceFromCamera!==e.__distanceFromCamera?i.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,ze=(i,e)=>i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?1:-1:i.__lastFrameVisited!==e.__lastFrameVisited?i.__lastFrameVisited>e.__lastFrameVisited?-1:1:i.__externalTileSet!==e.__externalTileSet?i.__externalTileSet?-1:1:0;class Ne{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e=null){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.plugins=[],this.preprocessURL=null;const t=new Ue;t.unloadPriorityCallback=ze;const s=new Y;s.maxJobs=4,s.priorityCallback=K;const n=new Y;n.maxJobs=1,n.priorityCallback=K,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}registerPlugin(e){if(e[Z]===!0)throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");this.plugins.push(e),e[Z]=!0,e.init(this)}getPluginByName(e){return this.plugins.find(t=>t.name===e)}traverse(e,t){const n=this.tileSets[this.rootURL];!n||!n.root||ue(n.root,(o,...r)=>(this.ensureChildrenArePreprocessed(o),e?e(o,...r):!1),t)}update(){const e=this.stats,t=this.lruCache,s=this.tileSets,n=s[this.rootURL];if(this.rootURL in s){if(!n||!n.root)return}else{this.invokeOnePlugin(r=>r.loadRootTileSet&&r.loadRootTileSet(this.rootURL));return}const o=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,he(o,this),de(o,this),fe(o,this),me(o,this),t.scheduleUnload()}resetFailedTiles(){const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===U&&(t.__loadingState=F)}),e.failed=0)}dispose(){this.invokeAllPlugins(s=>{s!==this&&s.dispose&&s.dispose()});const e=this.lruCache,t=[];this.traverse(s=>(t.push(s),!1));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}parseTile(e,t,s){return null}disposeTile(e){}preprocessNode(e,t,s=null){if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=new URL(e.content.uri,t+"/").toString()),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],e.content&&e.content.uri){const o=X(e.content.uri),r=!!(o&&o.toLowerCase()==="json");e.__externalTileSet=r,e.__contentEmpty=r}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=F,e.__loadIndex=0,e.__loadAbort=null,s===null?(e.__depth=0,e.__depthFromRenderedParent=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__contentEmpty?0:1),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const o=t[s];if("__depth"in o)break;this.preprocessNode(o,e.__basePath,e)}}fetchTileSet(e,t,s=null){return fetch(e,t).then(n=>{if(n.ok)return n.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${n.status} : ${n.statusText}`)}).then(n=>{const o=n.asset.version,[r,a]=o.split(".").map(u=>parseInt(u));console.assert(r<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),r===1&&a>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let l=e.replace(/\/[^/]*\/?$/,"");return l=new URL(l,window.location.href).toString(),this.preprocessNode(n.root,l,s),n})}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{let s=e;this.invokeAllPlugins(o=>s=o.preprocessURL?o.preprocessURL(s):s);const n=this.fetchTileSet(s,this.fetchOptions).then(o=>{t[e]=o});return n.catch(o=>{console.error(o),t[e]=o}),t[e]=n,n}}requestTileContents(e){if(e.__loadingState!==F)return;const t=this.stats,s=this.lruCache,n=this.downloadQueue,o=this.parseQueue,r=e.__externalTileSet;if(!s.add(e,c=>{c.__loadingState===I?(c.__loadAbort.abort(),c.__loadAbort=null):r?c.children.length=0:this.disposeTile(c),c.__loadingState===I?t.downloading--:c.__loadingState===W&&t.parsing--,c.__loadingState=F,c.__loadIndex++,o.remove(c),n.remove(c)}))return;e.__loadIndex++;const l=e.__loadIndex,u=new AbortController,h=u.signal;t.downloading++,e.__loadAbort=u,e.__loadingState=I;const m=c=>{e.__loadIndex===l&&(c.name!=="AbortError"?(o.remove(e),n.remove(e),e.__loadingState===W?t.parsing--:e.__loadingState===I&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(c),e.__loadingState=U):s.remove(e))};r?n.add(e,c=>{if(c.__loadIndex!==l)return Promise.resolve();let d=c.content.uri;return this.invokeAllPlugins(f=>d=f.preprocessURL?f.preprocessURL(d):d),this.fetchTileSet(d,Object.assign({signal:h},this.fetchOptions),c)}).then(c=>{e.__loadIndex===l&&(t.downloading--,e.__loadAbort=null,e.__loadingState=C,e.children.push(c.root))}).catch(m):n.add(e,c=>{if(c.__loadIndex!==l)return Promise.resolve();let d=c.content.uri;return this.invokeAllPlugins(f=>d=f.preprocessURL?f.preprocessURL(d):d),fetch(d,Object.assign({signal:h},this.fetchOptions))}).then(c=>{if(e.__loadIndex===l){if(c.ok)return c.arrayBuffer();throw new Error(`Failed to load model with error code ${c.status}`)}}).then(c=>{if(e.__loadIndex===l)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=W,o.add(e,d=>{if(d.__loadIndex!==l)return Promise.resolve();const f=d.content.uri,_=X(f);return this.parseTile(c,d,_)})}).then(()=>{e.__loadIndex===l&&(t.parsing--,e.__loadingState=C,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))}).catch(m)}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const o=e(t[n]);o&&s.push(o)}return s.length===0?null:Promise.all(s)}}const k=new w;class We extends Ce{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){return this.tilesRenderer.optimizeRaycast?(this.tilesRenderer.raycast(e,t),!1):!0}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?k.copy(this.matrix):k.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=k.elements,s=this.matrixWorld.elements;let n=!1;for(let o=0;o<16;o++){const r=t[o],a=s[o];if(Math.abs(r-a)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(k);const o=this.children;for(let r=0,a=o.length;r<a;r++)o[r].updateMatrixWorld()}}}}const je=parseInt(re)<165,B=new w,pe=new oe,j=new x,V=[];function _e(i,e){return i.distance-e.distance}function ge(i,e,t){je?(i.traverse(s=>{Object.getPrototypeOf(s).raycast.call(s,e,t)}),V.sort(_e)):e.intersectObject(i,!0,t)}function qe(i,e){ge(i,e,V);const t=V[0]||null;return V.length=0,t}function be(i,e,t,s=null){const{group:n,activeTiles:o}=i;i.ensureChildrenArePreprocessed(e),s===null&&(s=pe,B.copy(n.matrixWorld).invert(),s.copy(t.ray).applyMatrix4(B));const r=[],a=e.children;for(let h=0,m=a.length;h<m;h++){const c=a[h];if(!c.__used)continue;c.cached.boundingVolume.intersectRay(s,j)!==null&&(j.applyMatrix4(n.matrixWorld),r.push({distance:j.distanceToSquared(t.ray.origin),tile:c}))}r.sort(_e);let l=null,u=1/0;if(o.has(e)){const h=qe(e.cached.scene,t);h&&(l=h,u=h.distance*h.distance)}for(let h=0,m=r.length;h<m;h++){const c=r[h],d=c.distance,f=c.tile;if(d>u)break;const _=be(i,f,t,s);if(_){const g=_.distance*_.distance;g<u&&(l=_,u=g)}}return l}function xe(i,e,t,s,n=null){const{group:o,activeTiles:r}=i,{scene:a,boundingVolume:l}=e.cached;if(i.ensureChildrenArePreprocessed(e),n===null&&(n=pe,B.copy(o.matrixWorld).invert(),n.copy(t.ray).applyMatrix4(B)),!e.__used||!l.intersectsRay(n))return;r.has(e)&&ge(a,t,s);const u=e.children;for(let h=0,m=u.length;h<m;h++)xe(i,u[h],t,s,n)}const A=new x,L=new x,y=new x,E=new oe;class ee{constructor(e=new Fe,t=new w){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new w,this.points=new Array(8).fill().map(()=>new x),this.planes=new Array(6).fill().map(()=>new Me)}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,y).distanceTo(e)}containsPoint(e){return y.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(y)}intersectsRay(e){return E.copy(e).applyMatrix4(this.inverseTransform),E.intersectsBox(this.box)}intersectRay(e,t){return E.copy(e).applyMatrix4(this.inverseTransform),E.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:o,max:r}=n;let a=0;for(let l=-1;l<=1;l+=2)for(let u=-1;u<=1;u+=2)for(let h=-1;h<=1;h+=2)e[a].set(l<0?o.x:r.x,u<0?o.y:r.y,h<0?o.z:r.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){A.copy(this.box.min).applyMatrix4(this.transform),L.copy(this.box.max).applyMatrix4(this.transform),y.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(y,A),this.planes[1].setFromNormalAndCoplanarPoint(y,L).negate(),y.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(y,A),this.planes[3].setFromNormalAndCoplanarPoint(y,L).negate(),y.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(y,A),this.planes[5].setFromNormalAndCoplanarPoint(y,L).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const o=s[n];let r=-1/0;for(let a=0;a<8;a++){const l=t[a],u=o.distanceToPoint(l);r=r<u?u:r}if(r<0)return!1}for(let n=0;n<6;n++){const o=this.planes[n];let r=-1/0;for(let a=0;a<8;a++){const l=e.points[a],u=o.distanceToPoint(l);r=r<u?u:r}if(r<0)return!1}return!0}}const S=new x,v=new x,T=new x,te=new x,se=new x;class Ge{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&!s.intersectRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let o=-1/0,r=-1/0;s&&e.intersectSphere(s,te)&&(o=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(te)),n&&n.intersectRay(e,se)&&(r=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(se));const a=Math.max(o,r);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,o=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(o=s.distanceToPoint(e)),n>o?n:o}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new ee;S.set(e[3],e[4],e[5]),v.set(e[6],e[7],e[8]),T.set(e[9],e[10],e[11]);const n=S.length(),o=v.length(),r=T.length();S.normalize(),v.normalize(),T.normalize(),n===0&&S.crossVectors(v,T),o===0&&v.crossVectors(S,T),r===0&&T.crossVectors(S,v),s.transform.set(S.x,v.x,T.x,e[0],S.y,v.y,T.y,e[1],S.z,v.z,T.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-o,-r),s.box.max.set(n,o,r),s.update(),this.obb=s}setSphereData(e,t,s,n,o){const r=new Ie;r.center.set(e,t,s),r.radius=n,r.applyMatrix4(o),this.sphere=r}setRegionData(e,t,s,n,o,r){const a=new Ve(O,O,Be,t,n,e,s,o,r),l=new ee;a.getBoundingBox(l.box,l.transform),l.update(),this.region=a,this.regionObb=l}}const Je=new ke;function $e(i,e,t,s){const n=Je.set(i.normal.x,i.normal.y,i.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-i.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class Qe extends Ae{constructor(){super(),this.points=Array(8).fill().map(()=>new x)}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,o)=>{$e(n[0],n[1],n[2],t[o])})}}const ne=parseInt(re)<165,ye=Symbol("INITIAL_FRUSTUM_CULLED"),D=new w,q=new w,R=new x,He=new x(1,0,0),Xe=new x(0,1,0);function ie(i,e){i.traverse(t=>{t.frustumCulled=t[ye]&&e})}class Ye extends Ne{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{ie(t,!e)}))}constructor(...e){super(...e),this.group=new We(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this.optimizeRaycast=!0,this._eventDispatcher=new Le,this._upRotationMatrix=new w,this._autoDisableRendererCulling=!0,this._loadingTiles=!1;const t=new Ee;if(t.setURLModifier(s=>this.preprocessURL?this.preprocessURL(s):s),this.manager=t,ne){const s=this;this._overridenRaycast=function(n,o){s.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,n,o)}}}addEventListener(...e){this._eventDispatcher.addEventListener(...e)}hasEventListener(...e){this._eventDispatcher.hasEventListener(...e)}removeEventListener(...e){this._eventDispatcher.removeEventListener(...e)}dispatchEvent(...e){this._eventDispatcher.dispatchEvent(...e)}getBounds(...e){return console.warn("TilesRenderer: getBounds has been renamed to getBoundingBox."),this.getBoundingBox(...e)}getOrientedBounds(...e){return console.warn("TilesRenderer: getOrientedBounds has been renamed to getOrientedBoundingBox."),this.getOrientedBoundingBox(...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getAABB(e),!0):!1}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s?(s.getOBB(e,t),!0):!1}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached.scene;s&&e(s,t)})}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=be(this,this.root,e);s&&t.push(s)}else xe(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new H),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;return n.has(e)?(t instanceof H?n.get(e).copy(t):n.get(e).set(t,s),!0):!1}setResolutionFromRenderer(e,t){const s=this.cameraMap;if(!s.has(e))return!1;const n=s.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}fetchTileSet(e,...t){const s=super.fetchTileSet(e,...t);return s.then(n=>{queueMicrotask(()=>{this.dispatchEvent({type:"load-tile-set",tileSet:n,url:e})})}).catch(()=>{}),s}loadRootTileSet(...e){return super.loadRootTileSet(...e).then(()=>{switch((this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(Xe,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(He,Math.PI/2);break}}).catch(()=>{})}update(){this.dispatchEvent({type:"update-before"});const e=this.group,t=this.cameras,s=this.cameraMap,n=this.cameraInfo;if(t.length===0){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new Qe,isOrthographic:!1,sseDenominator:-1,position:new x,invScale:-1,pixelSize:0});q.copy(e.matrixWorld).invert(),R.setFromMatrixScale(q);const o=R.x;Math.abs(Math.max(R.x-R.y,R.x-R.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let r=0,a=n.length;r<a;r++){const l=t[r],u=n[r],h=u.frustum,m=u.position,c=s.get(l);(c.width===0||c.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const d=l.projectionMatrix.elements;if(u.isOrthographic=d[15]===1,u.isOrthographic){const f=2/d[0],_=2/d[5];u.pixelSize=Math.max(_/c.height,f/c.width)}else u.sseDenominator=2/d[5]/c.height;u.invScale=o,D.copy(e.matrixWorld),D.premultiply(l.matrixWorldInverse),D.premultiply(l.projectionMatrix),h.setFromProjectionMatrix(D),m.set(0,0,0),m.applyMatrix4(l.matrixWorld),m.applyMatrix4(q)}super.update(),this.dispatchEvent({type:"update-after"})}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new w;if(e.transform){const a=e.transform;for(let l=0;l<16;l++)n.elements[l]=a[l]}s&&n.premultiply(s.cached.transform);const o=new w().copy(n).invert(),r=new Ge;"sphere"in e.boundingVolume&&r.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&r.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&r.setRegionData(...e.boundingVolume.region),e.cached={_loadIndex:0,transform:n,transformInverse:o,active:!1,inFrustum:[],boundingVolume:r,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async parseTile(e,t,s){const n=t.cached;n._loadIndex++;const r=t.content.uri.split(/[\\/]/g);r.pop();const a=r.join("/"),l=this.fetchOptions,u=this.manager,h=n._loadIndex;let m=null;const c=n.transform,d=this._upRotationMatrix,f=(De(e)||s).toLowerCase();switch(f){case"b3dm":{const p=new ve(u);p.workingPath=a,p.fetchOptions=l,p.adjustmentTransform.copy(d),m=p.parse(e);break}case"pnts":{const p=new Te(u);p.workingPath=a,p.fetchOptions=l,m=p.parse(e);break}case"i3dm":{const p=new we(u);p.workingPath=a,p.fetchOptions=l,p.adjustmentTransform.copy(d),m=p.parse(e);break}case"cmpt":{const p=new Pe(u);p.workingPath=a,p.fetchOptions=l,p.adjustmentTransform.copy(d),m=p.parse(e).then(M=>M.scene);break}case"gltf":case"glb":{const p=new Re(u);p.workingPath=a,p.fetchOptions=l,m=p.parse(e);break}default:console.warn(`TilesRenderer: Content type "${f}" not supported.`),m=Promise.resolve(null);break}const _=this.stats;this._loadingTiles===!1&&_.parsing+_.downloading>0&&(this.dispatchEvent({type:"tiles-load-start"}),this._loadingTiles=!0);const g=await m;let b,z;if(g.isObject3D?(b=g,z=null):(b=g.scene,z=g),await this.invokeAllPlugins(p=>p.processTileModel&&p.processTileModel(b,t)),n._loadIndex!==h)return;b.updateMatrix(),(f==="glb"||f==="gltf")&&b.matrix.multiply(d),b.matrix.premultiply(c),b.matrix.decompose(b.position,b.quaternion,b.scale),b.traverse(p=>{p[ye]=p.frustumCulled}),ie(b,!this.autoDisableRendererCulling),ne&&b.traverse(p=>{p.raycast=this._overridenRaycast});const J=[],$=[],Q=[];b.traverse(p=>{if(p.geometry&&$.push(p.geometry),p.material){const M=p.material;J.push(p.material);for(const Se in M){const N=M[Se];N&&N.isTexture&&Q.push(N)}}}),n.materials=J,n.geometry=$,n.textures=Q,n.scene=b,n.metadata=z,this.dispatchEvent({type:"load-model",scene:b,tile:t}),this._loadingTiles===!0&&_.parsing+_.downloading===1&&(this.dispatchEvent({type:"tiles-load-end"}),this._loadingTiles=!1)}disposeTile(e){const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,o=t.textures,r=t.scene.parent;t.scene.traverse(a=>{a.userData.meshFeatures&&a.userData.meshFeatures.dispose(),a.userData.structuralMetadata&&a.userData.structuralMetadata.dispose()});for(let a=0,l=n.length;a<l;a++)n[a].dispose();for(let a=0,l=s.length;a<l;a++)s[a].dispose();for(let a=0,l=o.length;a<l;a++){const u=o[a];u.image instanceof ImageBitmap&&u.image.close(),u.dispose()}r&&r.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}this.activeTiles.delete(e),this.visibleTiles.delete(e),t._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,o=this.group;t?(o.add(s),n.add(e),s.updateMatrixWorld(!0)):(o.remove(s),n.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=t.inFrustum,n=this.cameras,o=this.cameraInfo,r=t.boundingVolume;let a=-1/0,l=1/0;for(let u=0,h=n.length;u<h;u++){if(!s[u])continue;const m=o[u],c=m.invScale;let d;if(m.isOrthographic){const f=m.pixelSize;d=e.geometricError/(f*c)}else{const _=r.distanceToPoint(m.position)*c,g=m.sseDenominator;d=e.geometricError/(_*g),l=Math.min(l,_)}a=Math.max(a,d)}e.__distanceFromCamera=l,e.__error=a}tileInView(e){const t=e.cached,s=t.boundingVolume,n=t.inFrustum,o=this.cameraInfo;let r=!1;for(let a=0,l=o.length;a<l;a++){const u=o[a].frustum;s.intersectsFrustum(u)?(r=!0,n[a]=!0):n[a]=!1}return r}}[["onLoadTileSet","load-tile-set"],["onLoadModel","load-model"],["onDisposeModel","dispose-model"],["onTileVisibilityChange","tile-visibility-change"]].forEach(([i,e])=>{const t=Symbol(i);Object.defineProperty(Ye.prototype,i,{get(){return this[t]||null},set(s){console.warn(`TilesRenderer: "${i}" has been deprecated in favor of the "${e}" event.`),this[t]&&this.removeEventListener(e,this[t]),this[t]=s,this.addEventListener(e,s)}})});export{Y as P,Ye as T,O as W,Be as a};
