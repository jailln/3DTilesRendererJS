import{k as T,q as E,j as k,r as x,i as S}from"./three.module-llkpyLgW.js";import{W as L,a as M,T as w}from"./TilesRenderer-COIzxhkT.js";import{E as P}from"./lil-gui.module.min-DGepGIYL.js";const U=new P(L,L,M);class z{constructor(){this.creditsCount={}}_adjustCredits(t,o){const n=this.creditsCount,e=t.split(/;/g);for(let a=0,m=e.length;a<m;a++){const l=e[a];l in n||(n[l]=0),n[l]+=o?1:-1,n[l]<=0&&delete n[l]}}addCredits(t){this._adjustCredits(t,!0)}removeCredits(t){this._adjustCredits(t,!1)}toString(){return Object.entries(this.creditsCount).sort((o,n)=>{const e=o[1];return n[1]-e}).map(o=>o[0]).join("; ")}}class W{constructor({apiToken:t}){this.name="GOOGLE_CLOUD_AUTH_PLUGIN",this.apiToken=t,this.sessionToken=null,this.tiles=null,this._onLoadCallback=null,this._visibilityChangeCallback=null}init(t){this.tiles=t,this._onLoadCallback=()=>{t.traverse(o=>o.content&&o.content.uri?(this.sessionToken=new URL(o.content.uri).searchParams.get("session"),!0):!1),t.removeEventListener("load-tile-set",this._onLoadCallback)},t.addEventListener("load-tile-set",this._onLoadCallback)}preprocessURL(t){return t=new URL(t),/^http/.test(t.protocol)&&(t.searchParams.append("key",this.apiToken),this.sessionToken!==null&&t.searchParams.append("session",this.sessionToken)),t.toString()}dispose(){this.tiles.removeEventListener("load-tile-set",this._onLoadCallback)}}const B="https://tile.googleapis.com",G=`${B}/v1/3dtiles/root.json`,b=new T,I=new E,R=s=>class extends s{get ellipsoid(){return U}constructor(t=G){super(t),this._credits=new z,this.fetchOptions.mode="cors",this.parseQueue.maxJobs=10,this.downloadQueue.maxJobs=30,this.lruCache.minSize=3e3,this.lruCache.maxSize=5e3,this.errorTarget=40,this.addEventListener("tile-visibility-change",o=>{const{tile:n,visible:e}=o,a=n.cached.metadata.asset.copyright||"";e?this._credits.addCredits(a):this._credits.removeCredits(a)})}getCreditsString(){return this._credits.toString()}setLatLonToYUp(t,o){const{ellipsoid:n,group:e}=this;I.set(Math.PI/2,Math.PI/2,0),b.makeRotationFromEuler(I),n.constructLatLonFrame(t,o,e.matrix).multiply(b).invert().decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0)}},D=R(w),A=new k;function C(s,t){if(s.isInterleavedBufferAttribute||s.array instanceof t)return s;const n=t===Int8Array||t===Int16Array||t===Int32Array?-1:0,e=new t(s.count*s.itemSize),a=new x(e,s.itemSize,!0),m=s.itemSize,l=s.count;for(let p=0;p<l;p++)for(let c=0;c<m;c++){const h=S.clamp(s.getComponent(p,c),n,1);a.setComponent(p,c,h)}return a}function j(s,t=Int16Array){const o=s.geometry,n=o.attributes,e=n.position;if(e.isInterleavedBufferAttribute||e.array instanceof t)return e;const a=new t(e.count*e.itemSize),m=new x(a,e.itemSize,!1),l=e.itemSize,p=e.count;o.computeBoundingBox();const c=o.boundingBox,{min:h,max:y}=c,u=2**(8*t.BYTES_PER_ELEMENT-1)-1,d=-u;for(let i=0;i<p;i++)for(let r=0;r<l;r++){const f=r===0?"x":r===1?"y":"z",g=h[f],v=y[f],_=S.mapLinear(e.getComponent(i,r),g,v,d,u);m.setComponent(i,r,_)}c.getCenter(A),s.position.add(A),s.scale.x*=.5*(y.x-h.x)/u,s.scale.y*=.5*(y.y-h.y)/u,s.scale.z*=.5*(y.z-h.z)/u,n.position=m,s.geometry.boundingBox=null,s.geometry.boundingSphere=null,s.updateMatrixWorld()}class H{constructor(t){this.tiles=null,this._options={generateNormals:!1,disableMipmaps:!0,compressIndex:!0,compressNormals:!0,compressUvs:!0,compressPosition:!0,uvType:Int8Array,normalType:Int8Array,positionType:Int16Array,...t}}init(t){this.tiles=t,this._onLoadModel=({scene:o})=>{const{generateNormals:n,disableMipmaps:e,compressIndex:a,compressUvs:m,compressNormals:l,compressPosition:p,uvType:c,normalType:h,positionType:y}=this._options;o.traverse(u=>{if(u.material&&e){const d=u.material;for(const i in d){const r=d[i];r&&r.isTexture&&(r.generateMipmaps=!1)}}if(u.geometry){const d=u.geometry,i=d.attributes;if(m){const{uv:r,uv1:f,uv2:g,uv3:v}=i;r&&(i.uv=C(r,c)),f&&(i.uv1=C(f,c)),g&&(i.uv2=C(g,c)),v&&(i.uv3=C(v,c))}if(n&&!i.normals&&d.computeVertexNormals(),l&&i.normals&&(i.normals=C(i.normals,h)),p&&j(u,y),a&&d.index){const r=i.position.count,f=d.index,g=r>65535?Uint32Array:r>255?Uint16Array:Uint8Array;if(!(f.array instanceof g)){const v=new g(d.index.count);v.set(f.array);const _=new x(v,1);d.setIndex(_)}}}})},t.addEventListener("load-model",this._onLoadModel)}dispose(){this.tiles.removeEventListener("load-model",this._onLoadModel)}}export{D as G,H as T,U as W,W as a};
