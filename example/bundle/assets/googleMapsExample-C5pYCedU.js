import{k as j,j as M,l as J,V as N,i as p,Q as X,W as Y,S as tt,a as et,O as ot}from"./three.module-llkpyLgW.js";import{G as it,e as rt}from"./GLTFLoader-KDqsLDsn.js";import{D as at}from"./DRACOLoader-8fQNjor_.js";import{E as st,g as nt,t as lt}from"./lil-gui.module.min-DGepGIYL.js";import{S as ct}from"./stats.module--VATS4Kh.js";import{C as pt}from"./CameraTransitionManager-B_WAu1BC.js";import{W as G,G as dt,a as mt,T as ht}from"./TileCompressionPlugin-2xtjR4nV.js";import{E as ut,c as A,N as gt,m as xt,s as ft,a as Ct,b as S}from"./EnvironmentControls-lFV-KO1M.js";import"./TilesRenderer-COIzxhkT.js";import"./B3DMLoader-BbySC5wb.js";import"./readMagicBytes-C5ZyfJzm.js";import"./LoaderBase-QLlipkOW.js";import"./PNTSLoader-e5Dx7bf2.js";import"./I3DMLoader-DX535fGk.js";import"./CMPTLoader-BdZwSK3N.js";import"./GLTFExtensionLoader-bnHC9qPo.js";const g=new j,y=new j,v=new M,s=new M,D=new M,U=new M,u=new M,z=new M,E=new M,Z=new M,x=new X,H=new M,_=new M,k={},C=new J,V=new st,W=new N,I=new N,L=new N,Mt=10;class Pt extends ut{get ellipsoid(){return this.tilesRenderer?this.tilesRenderer.ellipsoid:null}get tilesGroup(){return this.tilesRenderer?this.tilesRenderer.group:null}constructor(t=null,e=null,o=null,r=null){super(t,e,o),this._dragMode=0,this._rotationMode=0,this.maxZoom=.01,this.useFallbackPlane=!1,this.reorientOnDrag=!1,this.allowNegativeNearPlanes=!0,this.setTilesRenderer(r)}setScene(t){t===null&&this.tilesRenderer!==null?super.setScene(this.tilesRenderer.group):super.setScene(t)}getPivotPoint(t){const{camera:e,tilesGroup:o,ellipsoid:r}=this;return u.set(0,0,-1).transformDirection(e.matrixWorld),g.copy(o.matrixWorld).invert(),C.origin.copy(e.position),C.direction.copy(u),C.applyMatrix4(g),A(C,r,s),s.applyMatrix4(o.matrixWorld),(super.getPivotPoint(t)===null||t.distanceTo(C.origin)>s.distanceTo(C.origin))&&t.copy(s),t}getVectorToCenter(t){const{tilesGroup:e,camera:o}=this;return t.setFromMatrixPosition(e.matrixWorld).sub(o.position)}getDistanceToCenter(){return this.getVectorToCenter(s).length()}getUpDirection(t,e){const{tilesGroup:o,ellipsoid:r}=this;g.copy(o.matrixWorld).invert(),s.copy(t).applyMatrix4(g),r.getPositionToNormal(s,e),e.transformDirection(o.matrixWorld)}getCameraUpDirection(t){const{tilesGroup:e,ellipsoid:o,camera:r}=this;r.isOrthographicCamera?(this._getVirtualOrthoCameraPosition(s),g.copy(e.matrixWorld).invert(),s.applyMatrix4(g),o.getPositionToNormal(s,t),t.transformDirection(e.matrixWorld)):this.getUpDirection(r.position,t)}update(){if(!this.enabled||!this.tilesGroup||!this.camera)return;const{camera:t,tilesGroup:e,pivotMesh:o}=this;if(this._isNearControls()?this.scaleZoomOrientationAtEdges=this.zoomDelta<0:(this.state!==gt&&this._dragMode!==1&&this._rotationMode!==1&&(o.visible=!1),this.scaleZoomOrientationAtEdges=!1),super.update(),t.isPerspectiveCamera){let r=this.getDistanceToCenter();const i=this._getMaxPerspectiveDistance();r>i&&(s.setFromMatrixPosition(e.matrixWorld).sub(t.position).normalize().multiplyScalar(-1),t.position.setFromMatrixPosition(e.matrixWorld).addScaledVector(s,i),t.updateMatrixWorld(),r=i)}this.updateCameraClipPlanes(t)}updateCameraClipPlanes(t){const{tilesGroup:e,ellipsoid:o}=this;if(t.isPerspectiveCamera){const r=s.setFromMatrixPosition(e.matrixWorld).sub(t.position).length(),i=Math.max(...o.radius),n=.25*i,l=p.clamp((r-i)/n,0,1),m=p.lerp(1,1e3,l);t.near=Math.max(m,r-i-n);const h=g.copy(e.matrixWorld).invert();v.copy(t.position).applyMatrix4(h),o.getPositionToCartographic(v,k);const T=Math.max(o.getPositionElevation(v),Mt),R=o.calculateHorizonDistance(k.lat,T);t.far=R*3+.1,t.updateProjectionMatrix()}else{this._getVirtualOrthoCameraPosition(t.position,t),t.updateMatrixWorld(),g.copy(t.matrixWorld).invert(),s.setFromMatrixPosition(e.matrixWorld).applyMatrix4(g);const r=-s.z;t.near=r-Math.max(...o.radius)*1.1,t.far=r+.1,!this.allowNegativeNearPlanes&&t.near<0&&(t.position.addScaledVector(u,t.near),t.far-=t.near,t.near=0),t.updateProjectionMatrix(),t.updateMatrixWorld()}}resetState(){super.resetState(),this._dragMode=0,this._rotationMode=0}_updatePosition(){if(this._dragMode===1||this._isNearControls()){this._dragMode=1;const{raycaster:t,camera:e,pivotPoint:o,pointerTracker:r,domElement:i,tilesGroup:n}=this,l=v,m=E;r.getCenterPoint(W),xt(W.x,W.y,i,W),ft(t,W,e),g.copy(n.matrixWorld).invert(),t.ray.applyMatrix4(g);const h=s.copy(o).applyMatrix4(g).length();V.radius.setScalar(h),e.isPerspectiveCamera?V.intersectRay(t.ray,s)||Ct(t.ray,h,s):A(t.ray,V,s),s.applyMatrix4(n.matrixWorld),D.setFromMatrixPosition(n.matrixWorld),l.subVectors(o,D).normalize(),m.subVectors(s,D).normalize(),x.setFromUnitVectors(m,l),S(D,x,y),e.matrixWorld.premultiply(y),e.matrixWorld.decompose(e.position,e.quaternion,s)}else{this._dragMode=-1;const{pointerTracker:t,rotationSpeed:e,camera:o,pivotMesh:r,pivotPoint:i,tilesGroup:n}=this;let l;o.isPerspectiveCamera?l=o.position.distanceTo(i)*5*1e-10/devicePixelRatio:l=p.mapLinear(o.zoom,this._getOrthographicTransitionZoom(),this._getMinOrthographicZoom(),.001,.005),t.getCenterPoint(W),t.getPreviousCenterPoint(I),L.subVectors(W,I).multiplyScalar(l);const m=-L.x*e,h=-L.y*e;D.setFromMatrixPosition(n.matrixWorld),z.set(1,0,0).transformDirection(o.matrixWorld),U.set(0,1,0).transformDirection(o.matrixWorld),x.setFromAxisAngle(z,h),o.quaternion.premultiply(x),S(D,x,y),o.matrixWorld.premultiply(y),x.setFromAxisAngle(U,m),o.quaternion.premultiply(x),S(D,x,y),o.matrixWorld.premultiply(y),o.matrixWorld.decompose(o.position,o.quaternion,s),r.visible=!1}this._alignCameraUp(this.up)}_updateRotation(...t){this._rotationMode===1||this._isNearControls()?(this._rotationMode=1,super._updateRotation(...t)):(this.pivotMesh.visible=!1,this._rotationMode=-1),this._alignCameraUp(this.up)}_updateZoom(){const{zoomDelta:t,ellipsoid:e,zoomSpeed:o,zoomPoint:r,camera:i,maxZoom:n}=this;if(this._isNearControls()||t>0){if(t<0&&(this.zoomPointSet||this._updateZoomPoint())){u.set(0,0,-1).transformDirection(i.matrixWorld).normalize(),_.copy(this.up).multiplyScalar(-1),this.getUpDirection(r,H);const l=p.clamp(p.mapLinear(-H.dot(_),1,.95,0,1),0,1),m=1-u.dot(_),h=i.isOrthographicCamera?.05:1;_.lerpVectors(u,_,l*m*h).normalize(),x.setFromUnitVectors(u,_),S(r,x,y),i.matrixWorld.premultiply(y),i.matrixWorld.decompose(i.position,i.quaternion,_),this.zoomDirection.subVectors(r,i.position).normalize()}super._updateZoom()}else if(i.isPerspectiveCamera){const l=this._getPerspectiveTransitionDistance(),m=this._getMaxPerspectiveDistance(),h=p.mapLinear(this.getDistanceToCenter(),l,m,0,1);this._tiltTowardsCenter(p.lerp(0,.2,h)),this._alignCameraUpToNorth(p.lerp(0,.1,h));const T=this.getDistanceToCenter()-e.radius.x,R=t*T*o*.0025;this.getVectorToCenter(s).normalize(),this.camera.position.addScaledVector(s,R),this.camera.updateMatrixWorld(),this.zoomDelta=0}else{const l=this._getOrthographicTransitionZoom(),m=this._getMinOrthographicZoom(),h=p.mapLinear(i.zoom,l,m,0,1);this._tiltTowardsCenter(p.lerp(0,.2,h)),this._alignCameraUpToNorth(p.lerp(0,.1,h));const T=this.zoomDelta,R=Math.pow(.95,Math.abs(T*.05)),Q=T>0?1/Math.abs(R):R;i.zoom=Math.max(this._getMinOrthographicZoom(),Math.min(n,i.zoom*Q*o)),i.updateProjectionMatrix(),this.zoomDelta=0,this.zoomDirectionSet=!1}}_alignCameraUpToNorth(t){const{tilesGroup:e}=this;Z.set(0,0,1).transformDirection(e.matrixWorld),this._alignCameraUp(Z,t)}_alignCameraUp(t,e=null){const{camera:o}=this;u.set(0,0,-1).transformDirection(o.matrixWorld),z.set(-1,0,0).transformDirection(o.matrixWorld),E.crossVectors(t,u),e===null&&(e=1-Math.abs(u.dot(t)),e=p.mapLinear(e,0,1,-.01,1),e=p.clamp(e,0,1)**2),E.lerp(z,1-e).normalize(),x.setFromUnitVectors(z,E),o.quaternion.premultiply(x),o.updateMatrixWorld()}_tiltTowardsCenter(t){const{camera:e,tilesGroup:o}=this;u.set(0,0,-1).transformDirection(e.matrixWorld).normalize(),s.setFromMatrixPosition(o.matrixWorld).sub(e.position).normalize(),s.lerp(u,1-t).normalize(),x.setFromUnitVectors(u,s),e.quaternion.premultiply(x),e.updateMatrixWorld()}_getPerspectiveTransitionDistance(){const{camera:t,ellipsoid:e}=this;if(!t.isPerspectiveCamera)throw new Error;const o=Math.max(...e.radius),r=2*Math.atan(Math.tan(p.DEG2RAD*t.fov*.5)*t.aspect),i=o/Math.tan(p.DEG2RAD*t.fov*.5),n=o/Math.tan(r*.5);return Math.max(i,n)}_getMaxPerspectiveDistance(){const{camera:t,ellipsoid:e}=this;if(!t.isPerspectiveCamera)throw new Error;const o=Math.max(...e.radius),r=2*Math.atan(Math.tan(p.DEG2RAD*t.fov*.5)*t.aspect),i=o/Math.tan(p.DEG2RAD*t.fov*.5),n=o/Math.tan(r*.5);return 2*Math.max(i,n)}_getOrthographicTransitionZoom(){const{camera:t,ellipsoid:e}=this;if(!t.isOrthographicCamera)throw new Error;const o=t.top-t.bottom,r=t.right-t.left,i=Math.max(o,r),l=2*Math.max(...e.radius);return 2*i/l}_getMinOrthographicZoom(){const{camera:t,ellipsoid:e}=this;if(!t.isOrthographicCamera)throw new Error;const o=t.top-t.bottom,r=t.right-t.left,i=Math.min(o,r),l=2*Math.max(...e.radius);return .5*i/l}_getVirtualOrthoCameraPosition(t,e=this.camera){const{tilesGroup:o,ellipsoid:r}=this;if(!e.isOrthographicCamera)throw new Error;g.copy(o.matrixWorld).invert(),C.origin.copy(e.position),C.direction.set(0,0,-1).transformDirection(e.matrixWorld),C.applyMatrix4(g),A(C,r,v),v.applyMatrix4(o.matrixWorld);const i=e.top-e.bottom,n=e.right-e.left,l=Math.max(i,n)/e.zoom;u.set(0,0,-1).transformDirection(e.matrixWorld);const m=v.sub(e.position).dot(u);t.copy(e.position).addScaledVector(u,m-l*4)}_isNearControls(){const{camera:t}=this;return t.isPerspectiveCamera?this.getDistanceToCenter()<this._getPerspectiveTransitionDistance():t.zoom>this._getOrthographicTransitionZoom()}}let P,b,f,a,d,O,F;const wt=localStorage.getItem("googleApiKey")??"put-your-api-key-here",w={orthographic:!1,enableCacheDisplay:!1,enableRendererStats:!1,apiKey:wt,reload:K};yt();B();function K(){a&&(b.remove(a.group),a.dispose(),a=null),localStorage.setItem("googleApiKey",w.apiKey),a=new dt,a.registerPlugin(new mt({apiToken:w.apiKey})),a.registerPlugin(new ht),a.group.rotation.x=-Math.PI/2,a.errorTarget=50;const c=new at;c.setDecoderPath("https://unpkg.com/three@0.153.0/examples/jsm/libs/draco/gltf/");const t=new it(a.manager);t.setDRACOLoader(c),a.manager.addHandler(/\.gltf$/,t),b.add(a.group),a.setResolutionFromRenderer(d.camera,f),a.setCamera(d.camera),P.setTilesRenderer(a)}function yt(){f=new Y({antialias:!0}),f.setClearColor(1383455),document.body.appendChild(f.domElement),b=new tt,d=new pt(new et(60,window.innerWidth/window.innerHeight,1,16e7),new ot(-1,1,1,-1,1,16e7)),d.perspectiveCamera.position.set(48e5,257e4,1472e4),d.perspectiveCamera.lookAt(0,0,0),d.addEventListener("camera-changed",({camera:o,prevCamera:r})=>{a.deleteCamera(r),a.setCamera(o),P.setCamera(o)}),d.orthographicPositionalZoom=!1,P=new Pt(b,d.camera,f.domElement,null),K(),$(),window.addEventListener("resize",$,!1),window.addEventListener("hashchange",q);const c=new nt;c.width=300,c.add(w,"orthographic").onChange(o=>{P.getPivotPoint(d.fixedPoint),P.updateCameraClipPlanes(d.perspectiveCamera),P.updateCameraClipPlanes(d.orthographicCamera),d.toggle()});const t=c.addFolder("Google Tiles");t.add(w,"apiKey"),t.add(w,"reload");const e=c.addFolder("Example Options");e.add(w,"enableCacheDisplay"),e.add(w,"enableRendererStats"),O=document.createElement("div"),document.getElementById("info").appendChild(O),F=new ct,F.showPanel(0),document.body.appendChild(F.dom),q(),setInterval(vt,100)}function $(){const{perspectiveCamera:c,orthographicCamera:t}=d,e=window.innerWidth/window.innerHeight;c.aspect=e,c.updateProjectionMatrix(),t.left=-t.top*e,t.right=-t.left,t.updateProjectionMatrix(),f.setSize(window.innerWidth,window.innerHeight),f.setPixelRatio(window.devicePixelRatio)}function vt(){if(!a)return;const c=d.camera,t={},e=a.group.matrixWorld.clone().invert(),o=c.position.clone().applyMatrix4(e);G.getPositionToCartographic(o,t),t.lat*=p.RAD2DEG,t.lon*=p.RAD2DEG;const r=G.getPositionElevation(o),i=[parseFloat(t.lat.toFixed(4)),parseFloat(t.lon.toFixed(4)),r.toFixed(4)];window.history.replaceState(void 0,void 0,`#${i.join()}`)}function q(){const t=window.location.hash.replace(/^#/,"").split(/,/g).map(n=>parseFloat(n));if(t.length<2||t.findIndex(n=>Number.isNaN(n))!==-1)return;const[e,o,r=1e3]=t,i=d.camera;G.getCartographicToPosition(e*p.DEG2RAD,o*p.DEG2RAD,r,i.position),a.group.updateMatrixWorld(),i.position.applyMatrix4(a.group.matrixWorld),i.lookAt(0,0,0)}function B(){if(requestAnimationFrame(B),!a)return;P.enabled=!d.animating,P.update(),d.update(),d.animating&&P.updateCameraClipPlanes(d.camera);const c=d.camera;a.setResolutionFromRenderer(c,f),a.setCamera(c),c.updateMatrixWorld(),a.update(),f.render(b,c),F.update(),Dt()}function Dt(){const c=a.lruCache.itemList.length/a.lruCache.maxSize;let t="";if(w.enableCacheDisplay){t+=`Downloading: ${a.stats.downloading} Parsing: ${a.stats.parsing} Visible: ${a.visibleTiles.size}<br/>`;const i=new Set;a.traverse(l=>{const m=l.cached.scene;m&&m.traverse(h=>{h.geometry&&i.add(h.geometry)})});let n=0;i.forEach(l=>{n+=rt(l)}),t+=`Cache: ${(100*c).toFixed(2)}% ~${(n/1e3/1e3).toFixed(2)}mb<br/>`}if(w.enableRendererStats){const i=f.info.memory,n=f.info.programs.length;t+=`Geometries: ${i.geometries} Textures: ${i.textures} Programs: ${n}`}O.innerHTML!==t&&(O.innerHTML=t);const e=a.group.matrixWorld.clone().invert(),o=d.camera.position.clone().applyMatrix4(e),r={};G.getPositionToCartographic(o,r),document.getElementById("credits").innerText=lt(r.lat,r.lon)+`
`+a.getCreditsString()}
